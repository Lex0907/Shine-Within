<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shine Within - Quotes & Positivity</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <style>
    /* Global Styles */
    :root {
      --primary-grad-1: #a1c4fd;
      --primary-grad-2: #c2e9fb;
      --action-grad-1: #81ecec;
      --action-grad-2: #74b9ff;
      --text-main: #333;
      --text-light: #555;
      --bg-light: #fff;
      --bg-gradient: linear-gradient(to bottom right, #e0f7fa, #d1c4e9);
      --shadow-light: rgba(0, 0, 0, 0.1);
      --font-family: 'Segoe UI', sans-serif;
    }
    body {
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
      background: var(--bg-gradient);
      background-image: url('https://www.transparenttextures.com/patterns/vine.png');
      color: var(--text-main);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      --text-main: #f1f1f1;
      --text-light: #ccc;
      --bg-light: #1f1f1f;
      --bg-gradient: #121212;
      --shadow-light: rgba(255, 255, 255, 0.1);
      --primary-grad-1: #2e2e2e;
      --primary-grad-2: #3a3a3a;
      --action-grad-1: #2e2e2e;
      --action-grad-2: #74b9ff;
    }
    header {
      background: linear-gradient(90deg, var(--primary-grad-1), var(--primary-grad-2));
      padding: 1rem; text-align: center; box-shadow: 0 2px 4px var(--shadow-light); position: relative;
    }
    header h1 { margin: 0; font-size: 2rem; color: var(--text-main); text-shadow: 0 0 5px #fff; }
    body.dark-mode header h1 { text-shadow: none; }
    nav ul { list-style: none; padding: 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1rem; }
    nav a { text-decoration: none; color: var(--text-main); font-weight: bold; position: relative; }
    nav a::after { content: '‚ú®'; position: absolute; top: -10px; right: -10px; animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    section { padding: 2rem; max-width: 800px; margin: auto; }
    button {
      background: linear-gradient(to right, var(--action-grad-1), var(--action-grad-2));
      border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; color: #fff;
      box-shadow: 0 4px 10px var(--shadow-light); transition: all 0.2s ease;
    }
    button:hover { background: linear-gradient(to right, var(--action-grad-2), var(--action-grad-1)); transform: translateY(-2px); }
    button.active, button:focus { box-shadow: 0 0 15px var(--action-grad-1); transform: scale(1.05); outline: none; }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    input[type="text"], textarea {
      padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; background-color: var(--bg-light); color: var(--text-main);
    }
    .community-list { list-style: none; padding: 0; margin-top: 1rem; }
    .community-list li {
      background: rgba(255, 255, 255, 0.8); padding: 1rem 1.5rem; margin: 0.5rem 0; border-radius: 10px;
      box-shadow: 0 2px 8px var(--shadow-light); font-style: italic; display: flex; flex-direction: column; gap: 1rem;
    }
    body.dark-mode .community-list li { background-color: var(--bg-light); }
    .list-item-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .quote-actions { display: flex; align-items: center; flex-shrink: 0; }
    .quote-actions button { margin-left: 0.5rem; padding: 5px 10px; font-size: 0.8rem; }
    .quote-text { flex-grow: 1; margin-right: 1rem; word-break: break-word; }
    .like-container { display: flex; align-items: center; gap: 0.5rem; }
    .item-interactions { display: flex; align-items: center; gap: 1rem; margin-right: auto; }
    .like-btn, .share-btn, .reply-btn-main { background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0; transition: transform 0.2s ease; }
    .like-btn { color: #ff7675; }
    .share-btn, .reply-btn-main { color: var(--text-light); }
    .like-btn:hover, .share-btn:hover, .reply-btn-main:hover { transform: scale(1.2); }
    .like-count { font-weight: bold; font-size: 1rem; color: var(--text-light); }
    .quote-card { background: rgba(230, 244, 255, 0.9); padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px var(--shadow-light); font-style: italic; text-align: center; margin-bottom: 1rem; cursor: pointer; }
    body.dark-mode .quote-card { background-color: var(--bg-light); }
    footer { background: linear-gradient(90deg, var(--primary-grad-1), var(--primary-grad-2)); text-align: center; padding: 1rem; font-size: 0.9rem; box-shadow: 0 -2px 4px var(--shadow-light); }
    .theme-switch { position: absolute; top: 1rem; right: 1rem; display: inline-block; }
    .theme-switch input { display: none; }
    .slider { width: 50px; height: 24px; background-color: #74b9ff; border-radius: 24px; position: relative; cursor: pointer; transition: 0.3s; }
    .slider::before { content: "‚òÄÔ∏è"; position: absolute; font-size: 16px; line-height: 24px; left: 4px; transition: 0.3s; }
    input:checked + .slider { background-color: #2e2e2e; }
    input:checked + .slider::before { content: "üåô"; transform: translateX(26px); }
    .submission-box { display: flex; gap: 0.5rem; margin: 1rem 0; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--bg-light); padding: 2rem; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h3 { margin-top: 0; }
    .modal-content input, .modal-content textarea { width: 100%; margin-bottom: 1rem; }
    .modal-actions { text-align: right; }
    .modal-actions button { margin-left: 0.5rem; }
    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    #qotw-container { position: fixed; top: 150px; right: 20px; width: 250px; z-index: 999; }
    .qotw-board { background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 15px var(--shadow-light); border: 1px solid var(--primary-grad-1); }
    body.dark-mode .qotw-board { background: #2e2e2e; border-color: var(--action-grad-2); }
    .qotw-board h3 { margin-top: 0; text-align: center; }
    .qotw-board #qotw-text { font-style: italic; font-size: 0.95rem; min-height: 50px; }
    .qotw-board .qotw-likes { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; margin-top: 1rem; border-top: 1px solid #e0e0e0; padding-top: 1rem; }
    body.dark-mode .qotw-board .qotw-likes { border-top-color: #444; }
    .qotw-likes .like-btn { font-size: 1.2rem; }
    .list-controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
    .list-controls input { width: auto; flex-grow: 1; }
    .list-controls .sort-buttons button { font-size: 0.9rem; padding: 8px 15px; }
    .replies-section { border-top: 1px dashed #ccc; margin-top: 1rem; padding-top: 1rem; display: none; }
    .replies-list { list-style: none; padding-left: 1rem; }
    .replies-list li { background: rgba(0,0,0,0.03); padding: 0.75rem; border-radius: 8px; font-size: 0.9rem; font-style: normal; }
    body.dark-mode .replies-list li { background: rgba(255,255,255,0.05); }
    .journal-buttons { display: flex; gap: 1rem; margin-top: 1rem; }
    #journal-entry { min-height: 150px; margin-top: 1rem; }
    .journal-entry-display { border-bottom: 1px solid #eee; padding: 1rem 0; }
    body.dark-mode .journal-entry-display { border-bottom-color: #444; }
    .journal-entry-display small { color: var(--text-light); }
    .delete-journal-btn { background: #ff7675; font-size: 0.8rem; padding: 5px 10px; float: right; }
    @media (max-width: 1200px) { #qotw-container { position: static; width: auto; margin: 2rem; order: -1; } }
  </style>
</head>
<body>
  <header>
    <h1>Shine Within</h1>
    <label class="theme-switch">
      <input type="checkbox" id="theme-toggle" />
      <span class="slider"></span>
    </label>
    <nav>
      <ul>
        <li><a href="#home">Home</a></li>
        <li><a href="#quotes">Quotes</a></li>
        <li><a href="#journal">Journal</a></li>
        <li><a href="#family-questions">Family</a></li>
        <li><a href="#playlist">Playlist</a></li>
        <li><a href="#reflection">Reflection</a></li>
        <li><a href="#community">Community</a></li>
        <li><a href="#candle-section">Candle</a></li>
        <li><a href="#about">About</a></li>
        <li><a href="#contact">Contact</a></li>
      </ul>
    </nav>
  </header>

  <div id="qotw-container">
    <div class="qotw-board">
      <h3>üèÜ Quote of the Week</h3>
      <p id="qotw-text">Like some quotes to vote for next week's winner!</p>
      <div class="qotw-likes">
        <span class="like-btn" style="cursor:default;">‚ù§Ô∏è</span>
        <span id="qotw-count">0</span>
      </div>
    </div>
  </div>

  <section id="home">
    <h2>Welcome to Your Dose of Light</h2>
    <div id="daily-quote" class="quote-card">Quote of the Day loading...</div>
    <p>Here you‚Äôll find handpicked quotes and messages to uplift, inspire, and remind you of your strength.</p>
    <button id="show-random-quote-btn">Get a Random Quote</button>
    <div id="random-quote-display" class="quote-card" style="display: none; margin-top: 1rem;"></div>
  </section>

  <section id="quotes">
    <h2>Positivity Quotes</h2>
    <div class="filters">
      <button class="filter-btn" data-category="all">All</button>
      <button class="filter-btn" data-category="strength">Strength</button>
      <button class="filter-btn" data-category="healing">Healing</button>
      <button class="filter-btn" data-category="growth">Growth</button>
      <button class="filter-btn" data-category="encouragement">Encouragement</button>
    </div>
    <ul id="quote-list"></ul>
  </section>

  <section id="journal">
    <h2>Self-Care Journal</h2>
    <p>Need a moment to reflect? Use the prompt below to guide your thoughts in your private journal. Your entries are saved only on your device.</p>
    <div id="prompt-display" class="quote-card">Click for a new prompt!</div>
    <textarea id="journal-entry" placeholder="Write your thoughts here..."></textarea>
    <div class="journal-buttons">
      <button id="save-journal-btn">Save Entry</button>
      <button id="view-journal-btn">View My Journal</button>
    </div>
  </section>
  
  <section id="family-questions">
    <h2>Heart Full Family Questions</h2>
    <p>What stories and wisdom do you want to pass on? Get a question to help you share your heart with future generations.</p>
    <button id="show-family-question-btn">Ask a Family Question</button>
    <div id="family-question-display" class="quote-card" style="margin-top: 1rem; display: none;"></div>
  </section>

  <section id="playlist">
    <h2>Positivity Playlist</h2>
    <p>Here‚Äôs a collection of songs to lift your spirit, calm your heart, and help you feel connected.</p>
    <ul class="community-list">
      <li style="flex-direction: row;"><strong>"Keep Your Head Up"</strong> ‚Äì Andy Grammer</li>
      <li style="flex-direction: row;"><strong>"Scars to Your Beautiful"</strong> ‚Äì Alessia Cara</li>
      <li style="flex-direction: row;"><strong>"Rescue"</strong> ‚Äì Lauren Daigle</li>
      <li style="flex-direction: row;"><strong>"Rainbow"</strong> ‚Äì Kacey Musgraves</li>
      <li style="flex-direction: row;"><strong>"Fight Song"</strong> ‚Äì Rachel Platten</li>
      <li style="flex-direction: row;"><strong>"You Say"</strong> ‚Äì Lauren Daigle</li>
      <li style="flex-direction: row;"><strong>"Rise Up"</strong> ‚Äì Andra Day</li>
      <li style="flex-direction: row;"><strong>"Pocketful of Sunshine"</strong> ‚Äì Natasha Bedingfield üåª</li>
      <li style="flex-direction: row;"><strong>"Brave"</strong> ‚Äì Sara Bareilles</li>
      <li style="flex-direction: row;"><strong>"Who You Are"</strong> ‚Äì Jessie J</li>
    </ul>
  </section>

  <section id="reflection">
    <h2>What Brings You Hope?</h2>
    <p>Leave a short, anonymous answer below and share a little light with others who visit.</p>
    <div class="list-controls" id="reflection-controls">
      <input type="text" id="reflection-search" placeholder="Search reflections...">
      <div class="sort-buttons">
        <button data-sort="timestamp" class="active">Newest</button>
        <button data-sort="likeCount">Most Liked</button>
      </div>
    </div>
    <div class="submission-box">
      <input type="text" id="hope-input" placeholder="Your hopeful thought..." />
      <button id="submit-reflection-btn">Submit Reflection</button>
    </div>
    <ul id="reflections-list" class="community-list"></ul>
  </section>

  <section id="community">
    <h2>Share Your Favorite Quote</h2>
    <div class="list-controls" id="community-controls">
      <input type="text" id="community-search" placeholder="Search community quotes...">
      <div class="sort-buttons">
        <button data-sort="timestamp" class="active">Newest</button>
        <button data-sort="likeCount">Most Liked</button>
      </div>
    </div>
    <div class="submission-box">
      <input type="text" id="user-quote-input" placeholder="Enter your quote here" />
      <button id="submit-quote-btn">Submit Quote</button>
    </div>
    <h3>Community Quotes</h3>
    <ul id="submitted-quotes-list" class="community-list"></ul>
  </section>
  
  <section id="candle-section">
    <h2>Light a Candle</h2>
    <p>Honor someone you miss or carry in your heart by lighting a digital candle and sharing a message of remembrance or hope.</p>
    <div class="submission-box">
        <input type="text" id="candle-input" placeholder="Type their name or a message...">
        <button id="light-candle-btn">Light Candle üïØÔ∏è</button>
    </div>
    <ul id="candle-wall-list" class="community-list"></ul>
  </section>
  
  <section id="about">
    <h2>About This Site</h2>
    <p>This space was created to spread light in dark times, to remind you that you matter, and to share healing words. Every quote here is chosen with heart.</p>
  </section>

  <section id="contact">
    <h2>Contact Me</h2>
    <p>Have a quote you want featured or want to connect? Email: <a href="mailto:leann8285@gmail.com">leann8285@gmail.com</a></p>
  </section>

  <footer>
    <p>&copy; 2025 ShineWithinWisdomWaves. Created with heart by Alexis Kendle.</p>
  </footer>

  <div id="custom-modal" class="modal-overlay">
      <div class="modal-content">
          <h3 id="modal-title">Edit Entry</h3>
          <p id="modal-text"></p>
          <input type="text" id="modal-input" style="display:none;" />
          <div id="modal-journal-content" style="display:none; max-height: 400px; overflow-y: auto;"></div>
          <div class="modal-actions">
              <button id="modal-cancel">Cancel</button>
              <button id="modal-confirm">Confirm</button>
          </div>
      </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let userId = localStorage.getItem('shineWithinUserId') || `user_${Date.now()}${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('shineWithinUserId', userId);

        const COLLECTIONS = { submittedQuotes: 'submittedQuotes', reflections: 'reflections', candles: 'candles' };
        const allStaticQuotes = [ { text: "You are not behind ‚Äî you are becoming.", category: "Growth" }, { text: "Just because it's hard doesn't mean you're weak. It means you're trying.", category: "Encouragement" }, { text: "Healing isn't pretty, but you're still doing it.", category: "Healing" }, { text: "You‚Äôve already survived 100% of your worst days.", category: "Strength" }, { text: "The cracks are where the light gets in.", category: "Healing" }, { text: "You‚Äôre allowed to be both a masterpiece and a work in progress.", category: "Growth" }, { text: "You‚Äôre stronger than the storm you‚Äôre walking through.", category: "Strength" }, { text: "Small steps are still steps. Keep going.", category: "Encouragement" }, { text: "The human spirit is stronger than anything that can happen to it.", category: "Strength" }, { text: "The wound is the place where the Light enters you.", category: "Healing" }, { text: "Be gentle with yourself, you're doing the best you can.", category: "Healing" }, { text: "Every moment is a fresh beginning.", category: "Growth" }, { text: "Mistakes are proof that you are trying.", category: "Growth" }, { text: "Even the darkest night will end and the sun will rise.", category: "Encouragement" }, { text: "It's okay to not be okay. It's not okay to give up.", category: "Encouragement" }, { text: "The best way out is always through.", category: "Strength" }, { text: "Sometimes when you are in a dark place you think you have been buried, but you have actually been planted.", category: "Growth" }, { text: "Healing is not linear.", category: "Healing" }, { text: "What is coming is better than what is gone.", category: "Encouragement" }, { text: "There is bravery in being soft.", category: "Healing" } ];
        const prompts = [ "What is something you need to let go of today?", "What would you say to your younger self?", "What does healing look like for you right now?", "Write down 3 things you‚Äôre proud of yourself for.", "What is something you‚Äôve survived that you never thought you would?", "If you could speak to someone you miss, what would you tell them?", "What does being at peace mean to you?", "How have you grown in the past year ‚Äî emotionally or spiritually?" ];

        const modal = { overlay: document.getElementById('custom-modal'), title: document.getElementById('modal-title'), text: document.getElementById('modal-text'), input: document.getElementById('modal-input'), journalContent: document.getElementById('modal-journal-content'), cancel: document.getElementById('modal-cancel'), confirm: document.getElementById('modal-confirm'), resolve: null };
        function showModal(config) {
            modal.title.textContent = config.title;
            modal.text.textContent = config.text || '';
            modal.input.style.display = config.showInput ? 'block' : 'none';
            modal.journalContent.style.display = config.showJournal ? 'block' : 'none';
            if (config.showInput) modal.input.value = config.inputValue || '';
            if (config.showJournal) modal.journalContent.innerHTML = config.journalHTML || '';
            modal.confirm.textContent = config.confirmText || 'Confirm';
            modal.overlay.style.display = 'flex';
            return new Promise(resolve => modal.resolve = resolve);
        }
        modal.cancel.addEventListener('click', () => { modal.overlay.style.display = 'none'; if (modal.resolve) modal.resolve({ confirmed: false }); });
        modal.confirm.addEventListener('click', () => { modal.overlay.style.display = 'none'; if (modal.resolve) modal.resolve({ confirmed: true, value: modal.input.value }); });
        
        async function shareContent(text) {
            try {
                if (navigator.share) {
                    await navigator.share({ title: 'A quote from Shine Within', text: `"${text}"` });
                } else {
                    await navigator.clipboard.writeText(`"${text}"`);
                    alert('Quote copied to clipboard!');
                }
            } catch (err) {
                console.error("Could not share:", err);
            }
        }
        
        function setupListControls(controlsId, collectionName, listId, isCandle = false) {
            const controls = document.getElementById(controlsId);
            if (!controls) return;
            const searchInput = controls.querySelector('input[type="text"]');
            const sortButtons = controls.querySelectorAll('.sort-buttons button');
            let currentSort = 'timestamp';
            let allDocs = [];
            let unsubscribe;

            function render(docsToRender) {
                const listElement = document.getElementById(listId);
                listElement.innerHTML = "";
                if (docsToRender.length === 0 && searchInput.value) {
                    listElement.innerHTML = "<li>No items match your search.</li>";
                } else if (docsToRender.length === 0) {
                     listElement.innerHTML = "<li>Nothing here yet. Be the first to share!</li>";
                } else {
                    docsToRender.forEach(doc => listElement.appendChild(createListItem(doc, collectionName, isCandle)));
                }
            }

            function filterAndRender() {
                const searchTerm = searchInput.value.toLowerCase();
                const filtered = searchTerm ? allDocs.filter(doc => doc.data().text.toLowerCase().includes(searchTerm)) : allDocs;
                render(filtered);
            }

            sortButtons.forEach(button => {
                button.addEventListener('click', () => {
                    sortButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentSort = button.dataset.sort;
                    fetchAndRender();
                });
            });
            searchInput.addEventListener('keyup', filterAndRender);
            
            function fetchAndRender() {
                if (unsubscribe) unsubscribe();
                unsubscribe = db.collection(collectionName).orderBy(currentSort, 'desc').onSnapshot(snapshot => {
                    allDocs = snapshot.docs;
                    filterAndRender();
                });
            }
            fetchAndRender();
        }

        function createListItem(doc, collectionName, isCandle) {
            const item = doc.data();
            const li = document.createElement("li");
            li.setAttribute('data-id', doc.id);

            const mainDiv = document.createElement('div');
            mainDiv.className = 'list-item-main';

            const textSpan = document.createElement('span');
            textSpan.textContent = isCandle ? `üïØÔ∏è ${item.text}` : `"${item.text}"`;
            textSpan.className = 'quote-text';

            const interactionsDiv = document.createElement('div');
            interactionsDiv.className = 'item-interactions';
            const likeContainer = document.createElement('div');
            likeContainer.className = 'like-container';
            const likeBtn = document.createElement('button');
            likeBtn.className = 'like-btn';
            likeBtn.innerHTML = item.likes?.includes(userId) ? '‚ù§Ô∏è' : '‚ô°';
            const likeCount = document.createElement('span');
            likeCount.className = 'like-count';
            likeCount.textContent = item.likeCount ?? 0;
            likeContainer.appendChild(likeBtn);
            likeContainer.appendChild(likeCount);
            interactionsDiv.appendChild(likeContainer);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'quote-actions';
            const shareBtn = document.createElement('button');
            shareBtn.className = 'share-btn'; shareBtn.title = "Share"; shareBtn.innerHTML = 'üì≤';
            const replyBtn = document.createElement('button');
            replyBtn.className = 'reply-btn-main'; replyBtn.title = "Reply"; replyBtn.innerHTML = 'üí¨';
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit'; editBtn.className = 'edit-btn';
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete'; deleteBtn.className = 'delete-btn';
            actionsDiv.appendChild(shareBtn);
            if (!isCandle) actionsDiv.appendChild(replyBtn); // No replies for candles
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            mainDiv.appendChild(textSpan);
            mainDiv.appendChild(interactionsDiv);
            mainDiv.appendChild(actionsDiv);
            li.appendChild(mainDiv);

            const repliesSection = document.createElement('div');
            repliesSection.className = 'replies-section';
            li.appendChild(repliesSection);
            
            return li;
        }

        function setupListEventListeners(listId, collectionName) {
            document.getElementById(listId).addEventListener('click', async e => {
                const target = e.target;
                const li = target.closest('li[data-id]');
                if (!li) return;
                const docId = li.getAttribute('data-id');

                if (target.matches('.edit-btn')) {
                    const text = li.querySelector('.quote-text').textContent.replace(/["üïØÔ∏è]/g, '').trim();
                    const { confirmed, value } = await showModal({ title: 'Edit Entry', showInput: true, inputValue: text });
                    if (confirmed && value) await db.collection(collectionName).doc(docId).update({ text: value });
                } else if (target.matches('.delete-btn')) {
                    const { confirmed } = await showModal({ title: 'Confirm Deletion' });
                    if (confirmed) await db.collection(collectionName).doc(docId).delete();
                } else if (target.matches('.like-btn')) {
                    handleLike(collectionName, docId);
                } else if (target.matches('.share-btn')) {
                    const text = li.querySelector('.quote-text').textContent.replace(/["üïØÔ∏è]/g, '').trim();
                    shareContent(text);
                } else if (target.matches('.reply-btn-main')) {
                    toggleReplies(li, collectionName, docId);
                } else if (target.matches('.submit-reply-btn')) {
                    e.preventDefault();
                    const replyInput = li.querySelector('.reply-input');
                    if (replyInput && replyInput.value) {
                        await addReply(collectionName, docId, replyInput.value);
                        replyInput.value = '';
                    }
                }
            });
        }
        
        async function handleLike(collectionName, docId) {
            const docRef = db.collection(collectionName).doc(docId);
            await db.runTransaction(async t => {
                const doc = await t.get(docRef);
                const data = doc.data();
                const likes = data.likes || [];
                const userIndex = likes.indexOf(userId);
                userIndex === -1 ? likes.push(userId) : likes.splice(userIndex, 1);
                t.update(docRef, { likes: likes, likeCount: likes.length });
            });
            displayQuoteOfTheWeek(); // Refresh QOTW after a like
        }

        async function addReply(collectionName, parentId, text) {
            await db.collection(collectionName).doc(parentId).collection('replies').add({
                text, userId, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        async function toggleReplies(li, collectionName, docId) {
            const repliesSection = li.querySelector('.replies-section');
            if (repliesSection.style.display === 'block') {
                repliesSection.style.display = 'none';
                return;
            }
            repliesSection.style.display = 'block';
            repliesSection.innerHTML = '<em>Loading replies...</em>';
            
            db.collection(collectionName).doc(docId).collection('replies').orderBy('timestamp').onSnapshot(snapshot => {
                let html = '<ul class="replies-list">';
                snapshot.forEach(doc => html += `<li>${doc.data().text}</li>`);
                html += '</ul><form class="submission-box"><input type="text" class="reply-input" placeholder="Write a reply..."><button type="submit" class="submit-reply-btn">Reply</button></form>';
                repliesSection.innerHTML = html;
            });
        }

        async function displayQuoteOfTheWeek() {
            const qotwText = document.getElementById('qotw-text'), qotwCount = document.getElementById('qotw-count');
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const query = db.collection(COLLECTIONS.submittedQuotes).where('timestamp', '>=', sevenDaysAgo).orderBy('likeCount', 'desc').orderBy('timestamp', 'desc').limit(1);
            const snapshot = await query.get();
            if (snapshot.empty) {
                qotwText.textContent = "No top quote this week. Like some quotes to vote!";
                qotwCount.textContent = "0";
            } else {
                const topQuote = snapshot.docs[0].data();
                qotwText.textContent = `"${topQuote.text}"`;
                qotwCount.textContent = topQuote.likeCount || 0;
            }
        }
        
        function handleResponsiveBoard() {
            const qotwContainer = document.getElementById('qotw-container');
            const communitySection = document.getElementById('community');
            if (window.innerWidth <= 1200) {
                if (qotwContainer.parentNode !== communitySection) communitySection.prepend(qotwContainer);
            } else {
                if (qotwContainer.parentNode !== document.body) document.body.appendChild(qotwContainer);
            }
        }

        // Journal Logic
        const journal = {
            promptEl: document.getElementById('prompt-display'),
            entryEl: document.getElementById('journal-entry'),
            getEntries: () => JSON.parse(localStorage.getItem('journalEntries') || '[]'),
            saveEntries: entries => localStorage.setItem('journalEntries', JSON.stringify(entries)),
            newPrompt: () => journal.promptEl.textContent = prompts[Math.floor(Math.random() * prompts.length)]
        };
        document.getElementById('save-journal-btn').addEventListener('click', () => {
            if(!journal.entryEl.value.trim()) return alert("Please write something in your journal entry.");
            const entries = journal.getEntries();
            entries.unshift({ id: Date.now(), prompt: journal.promptEl.textContent, entry: journal.entryEl.value, date: new Date().toISOString() });
            journal.saveEntries(entries);
            journal.entryEl.value = '';
            alert('Journal entry saved!');
        });
        document.getElementById('view-journal-btn').addEventListener('click', () => {
            let html = journal.getEntries().map(entry => `
                <div class="journal-entry-display" data-id="${entry.id}">
                    <p><strong>${entry.prompt}</strong></p>
                    <p>${entry.entry.replace(/\n/g, '<br>')}</p>
                    <div>
                        <small>${new Date(entry.date).toLocaleString()}</small>
                        <button class="delete-journal-btn">Delete</button>
                    </div>
                </div>`).join('');
            if(!html) html = "<p>You have no journal entries yet.</p>";
            showModal({ title: 'My Journal', showJournal: true, journalHTML: html, confirmText: 'Close' });
        });
        modal.journalContent.addEventListener('click', e => {
            if (e.target.matches('.delete-journal-btn')) {
                const entryId = e.target.closest('.journal-entry-display').dataset.id;
                let entries = journal.getEntries().filter(entry => entry.id != entryId);
                journal.saveEntries(entries);
                e.target.closest('.journal-entry-display').remove();
            }
        });
        journal.promptEl.addEventListener('click', journal.newPrompt);
        journal.newPrompt();

        // Initializations
        document.getElementById("theme-toggle").addEventListener("change", () => document.body.classList.toggle("dark-mode"));
        
        setupListControls('community-controls', COLLECTIONS.submittedQuotes, 'submitted-quotes-list');
        setupListControls('reflection-controls', COLLECTIONS.reflections, 'reflections-list');
        db.collection(COLLECTIONS.candles).orderBy('timestamp', 'desc').onSnapshot(snapshot => {
            const listElement = document.getElementById('candle-wall-list');
            listElement.innerHTML = "";
            snapshot.docs.forEach(doc => listElement.appendChild(createListItem(doc, COLLECTIONS.candles, true)));
        });
        
        setupListEventListeners('submitted-quotes-list', COLLECTIONS.submittedQuotes);
        setupListEventListeners('reflections-list', COLLECTIONS.reflections);
        setupListEventListeners('candle-wall-list', COLLECTIONS.candles);

        displayQuoteOfTheWeek();
        handleResponsiveBoard();
        window.addEventListener('resize', handleResponsiveBoard);
        
        // Static content buttons
        document.getElementById('show-random-quote-btn').addEventListener('click', () => document.getElementById('random-quote-display').style.display = 'block');
        document.getElementById('show-family-question-btn').addEventListener('click', () => document.getElementById('family-question-display').style.display = 'block');
        // Filter buttons for static quotes
        document.querySelectorAll(".filter-btn").forEach(button => {
            button.addEventListener("click", () => {
                document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
                button.classList.add("active");
                const category = button.getAttribute("data-category");
                const list = document.getElementById("quote-list");
                list.innerHTML = "";
                const filtered = category === "all" ? allStaticQuotes : allStaticQuotes.filter(q => q.category === category);
                filtered.forEach(q => {
                    const li = document.createElement("li");
                    li.className = 'quote-card';
                    li.textContent = q.text;
                    list.appendChild(li);
                });
            });
        });
    });
  </script>
</body>
</html>
